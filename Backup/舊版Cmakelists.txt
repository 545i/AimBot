cmake_minimum_required(VERSION 3.10)
project(ColorDetection)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Windows 專用設置
if(MSVC)
    add_compile_options("/utf-8")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} /SUBSYSTEM:WINDOWS")
    add_definitions(-DUNICODE -D_UNICODE)
endif()

# OpenCV paths
set(OpenCV_DIR "D:/C++/Opencv/build")
set(OpenCV_LIB_DIR "D:/C++/Opencv/build/x64/vc16/lib")
set(OpenCV_BIN_DIR "D:/C++/Opencv/build/x64/vc16/bin")

find_package(OpenCV REQUIRED)
include_directories(${OpenCV_INCLUDE_DIRS})
link_directories(${OpenCV_LIB_DIR})

# Source files
set(SOURCE_FILES
    main.cpp
)

set(HEADERS
    KeyboardMouseControl.h
)

# 資源文件設置
set(WIN32_RESOURCES
    app.rc
)

# 修改後的執行檔設置
add_executable(${PROJECT_NAME} WIN32 
    ${SOURCE_FILES}
    ${HEADERS}
    ${WIN32_RESOURCES}
)

# Link libraries
target_link_libraries(${PROJECT_NAME} 
    ${OpenCV_LIBS}
    d3d11
    dxgi
    comctl32
)

# Copy OpenCV DLLs
if(WIN32)
    file(COPY "${OpenCV_BIN_DIR}/opencv_videoio_ffmpeg4100_64.dll" DESTINATION ${CMAKE_BINARY_DIR}/Release)
    file(COPY "${OpenCV_BIN_DIR}/opencv_videoio_msmf4100_64.dll" DESTINATION ${CMAKE_BINARY_DIR}/Release)
    file(COPY "${OpenCV_BIN_DIR}/opencv_videoio_msmf4100_64d.dll" DESTINATION ${CMAKE_BINARY_DIR}/Release)
endif()

# Output directory
set_target_properties(${PROJECT_NAME} PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY_RELEASE ${CMAKE_BINARY_DIR}/Release
)

# 只複製 DLL 文件
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${OpenCV_BIN_DIR}/opencv_world4100.dll"
        "${OpenCV_BIN_DIR}/opencv_world4100d.dll"
        "${OpenCV_BIN_DIR}/opencv_videoio_ffmpeg4100_64.dll"
        "${OpenCV_BIN_DIR}/opencv_videoio_msmf4100_64.dll"
        "${OpenCV_BIN_DIR}/opencv_videoio_msmf4100_64d.dll"
        $<TARGET_FILE_DIR:${PROJECT_NAME}>
)

# DLL 文件複製
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    ${CMAKE_SOURCE_DIR}/ddll64.dll
    $<TARGET_FILE_DIR:${PROJECT_NAME}>
)
